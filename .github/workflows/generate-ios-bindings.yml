name: Generate iOS Bindings

on:
  workflow_dispatch:

jobs:
  generate-bindings:
    name: Generate iOS Bindings
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fetch Clarity Version and Download URL
        id: clarity_info
        run: |
          echo "üîç Fetching latest Clarity version from Package.swift..."

          # Download Package.swift from clarity-apps repo
          PACKAGE_SWIFT_URL="https://raw.githubusercontent.com/microsoft/clarity-apps/main/Package.swift"
          curl -s -o Package.swift "$PACKAGE_SWIFT_URL"

          if [ ! -f Package.swift ]; then
            echo "‚ùå Error: Failed to download Package.swift"
            exit 1
          fi

          echo "üìÑ Package.swift content:"
          cat Package.swift
          echo ""

          # Extract version from the .binaryTarget url
          # Look for pattern like: Clarity-X.Y.Z.xcframework.zip
          DOWNLOAD_URL=$(grep -o 'https://[^"]*\.xcframework\.zip' Package.swift | head -1)

          if [ -z "$DOWNLOAD_URL" ]; then
            echo "‚ùå Error: Could not extract download URL from Package.swift"
            exit 1
          fi

          # Extract version from URL (e.g., Clarity-1.0.0.xcframework.zip -> 1.0.0)
          # Use more precise regex to match version pattern
          CLARITY_VERSION=$(echo "$DOWNLOAD_URL" | grep -oE 'Clarity-[0-9]+\.[0-9]+\.[0-9]+' | sed 's/Clarity-//')

          if [ -z "$CLARITY_VERSION" ]; then
            echo "‚ùå Error: Could not extract version from download URL"
            echo "Download URL: $DOWNLOAD_URL"
            exit 1
          fi

          echo "‚úÖ Clarity Version: $CLARITY_VERSION"
          echo "‚úÖ Download URL: $DOWNLOAD_URL"

          # Export to environment for subsequent steps
          echo "CLARITY_VERSION=$CLARITY_VERSION" >> $GITHUB_ENV
          echo "FRAMEWORK_URL=$DOWNLOAD_URL" >> $GITHUB_ENV

          # Also set as output for this step
          echo "version=$CLARITY_VERSION" >> $GITHUB_OUTPUT
          echo "url=$DOWNLOAD_URL" >> $GITHUB_OUTPUT

      - name: Install Objective Sharpie
        run: |
          echo "üì¶ Installing Objective Sharpie..."
          brew install --cask objectivesharpie || echo "‚ö†Ô∏è  Objective Sharpie may already be installed"
          sharpie -v

      - name: Display SDK Information
        run: |
          echo "üîç Available iOS SDKs:"
          sharpie xcode -sdks
          echo ""

          # Extract the iOS SDK - the format is typically "sdk: iphoneos18.2"
          # We need to get the full SDK name without the "sdk:" prefix
          IOS_SDK=$(sharpie xcode -sdks 2>&1 | grep -i iphoneos | grep -o 'iphoneos[0-9.]*' | tail -1)

          if [ -z "$IOS_SDK" ]; then
            echo "‚ùå Error: Could not detect iOS SDK"
            echo "Available SDKs:"
            sharpie xcode -sdks
            exit 1
          fi

          echo "‚úÖ Selected iOS SDK: $IOS_SDK"
          echo "IOS_SDK=$IOS_SDK" >> $GITHUB_ENV

      - name: Download Clarity Framework
        run: |
          echo "‚¨áÔ∏è  Downloading Clarity v$CLARITY_VERSION framework..."
          cd src/Maui.MicrosoftClarity.iOS

          FRAMEWORK_ZIP="Clarity-${CLARITY_VERSION}.xcframework.zip"

          # Remove existing file if it exists
          rm -f "$FRAMEWORK_ZIP"

          # Download with retry and proper error handling
          echo "Downloading from: $FRAMEWORK_URL"
          HTTP_CODE=$(curl -L -w "%{http_code}" -o "$FRAMEWORK_ZIP" "$FRAMEWORK_URL")

          if [ "$HTTP_CODE" != "200" ]; then
            echo "‚ùå Error: HTTP $HTTP_CODE returned from server"
            echo "URL may be incorrect or file doesn't exist for version ${{ inputs.clarity_version }}"
            exit 1
          fi

          # Verify the download
          if [ ! -f "$FRAMEWORK_ZIP" ]; then
            echo "‚ùå Error: Downloaded file not found"
            exit 1
          fi

          FILE_SIZE=$(stat -f%z "$FRAMEWORK_ZIP" 2>/dev/null || stat -c%s "$FRAMEWORK_ZIP")
          if [ "$FILE_SIZE" -lt 1000 ]; then
            echo "‚ùå Error: Downloaded file is too small ($FILE_SIZE bytes), likely an error page"
            cat "$FRAMEWORK_ZIP"
            exit 1
          fi

          # Verify it's a valid zip file
          if ! unzip -t "$FRAMEWORK_ZIP" > /dev/null 2>&1; then
            echo "‚ùå Error: Downloaded file is not a valid zip archive"
            file "$FRAMEWORK_ZIP"
            exit 1
          fi

          echo "‚úÖ Download complete and verified"
          ls -lh "$FRAMEWORK_ZIP"

      - name: Extract Framework
        run: |
          echo "üì¶ Extracting framework..."
          cd src/Maui.MicrosoftClarity.iOS

          FRAMEWORK_ZIP="Clarity-${CLARITY_VERSION}.xcframework.zip"
          FRAMEWORK_DIR="Clarity.xcframework"

          unzip -q "$FRAMEWORK_ZIP"
          echo "‚úÖ Extraction complete"

          echo "üßπ Removing .swiftmodule and .dSYM directories (required for Windows build)..."
          find "$FRAMEWORK_DIR" -type d -name "*.swiftmodule" -exec rm -rf {} + 2>/dev/null || true
          find "$FRAMEWORK_DIR" -type d -name "*.dSYM" -exec rm -rf {} + 2>/dev/null || true
          echo "‚úÖ .swiftmodule and .dSYM directories removed"

          echo "üìÅ Framework structure:"
          ls -la "$FRAMEWORK_DIR"

      - name: Verify Framework Structure
        run: |
          echo "üîç Verifying framework structure..."
          cd src/Maui.MicrosoftClarity.iOS

          FRAMEWORK_DIR="Clarity.xcframework"
          FRAMEWORK_HEADERS="$FRAMEWORK_DIR/ios-arm64/Clarity.framework/Headers"
          SWIFT_HEADER="$FRAMEWORK_HEADERS/Clarity-Swift.h"

          if [ ! -f "$SWIFT_HEADER" ]; then
            echo "‚ùå Error: Swift header not found at $SWIFT_HEADER"
            exit 1
          fi

          echo "‚úÖ Framework structure verified"
          echo "  Headers: $FRAMEWORK_HEADERS"
          echo "  Swift Header: $SWIFT_HEADER"

      - name: Generate Bindings with Objective Sharpie
        run: |
          echo "‚öôÔ∏è  Generating bindings with Objective Sharpie..."
          cd src/Maui.MicrosoftClarity.iOS

          FRAMEWORK_DIR="Clarity.xcframework"
          OUTPUT_DIR="ClarityBindingOutput"
          NAMESPACE="MicrosoftClarityiOS"
          FRAMEWORK_HEADERS="$FRAMEWORK_DIR/ios-arm64/Clarity.framework/Headers"
          SWIFT_HEADER="$FRAMEWORK_HEADERS/Clarity-Swift.h"

          echo "Running: sharpie bind --sdk=$IOS_SDK --namespace=$NAMESPACE"

          sharpie bind \
            --sdk="$IOS_SDK" \
            --output="$OUTPUT_DIR" \
            --namespace="$NAMESPACE" \
            --scope="$FRAMEWORK_HEADERS" \
            "$SWIFT_HEADER"

          echo "‚úÖ Bindings generated successfully"

      - name: Display Generated Artifacts
        run: |
          echo "üìÑ Generated Artifacts:"
          echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
          cd src/Maui.MicrosoftClarity.iOS

          OUTPUT_DIR="ClarityBindingOutput"

          if [ -d "$OUTPUT_DIR" ]; then
            echo ""
            echo "üìÇ Output Directory: $OUTPUT_DIR/"
            echo ""

            if [ -f "$OUTPUT_DIR/ApiDefinitions.cs" ]; then
              FILE_SIZE=$(ls -lh "$OUTPUT_DIR/ApiDefinitions.cs" | awk '{print $5}')
              LINE_COUNT=$(wc -l < "$OUTPUT_DIR/ApiDefinitions.cs")
              VERIFY_COUNT=$(grep -c "\[Verify" "$OUTPUT_DIR/ApiDefinitions.cs" 2>/dev/null || echo "0")
              echo "‚úÖ ApiDefinitions.cs"
              echo "   Size: $FILE_SIZE"
              echo "   Lines: $LINE_COUNT"
              echo "   [Verify] attributes: $VERIFY_COUNT"
              echo ""
            else
              echo "‚ùå ApiDefinitions.cs not found"
            fi

            if [ -f "$OUTPUT_DIR/StructsAndEnums.cs" ]; then
              FILE_SIZE=$(ls -lh "$OUTPUT_DIR/StructsAndEnums.cs" | awk '{print $5}')
              LINE_COUNT=$(wc -l < "$OUTPUT_DIR/StructsAndEnums.cs")
              VERIFY_COUNT=$(grep -c "\[Verify" "$OUTPUT_DIR/StructsAndEnums.cs" 2>/dev/null || echo "0")
              echo "‚úÖ StructsAndEnums.cs"
              echo "   Size: $FILE_SIZE"
              echo "   Lines: $LINE_COUNT"
              echo "   [Verify] attributes: $VERIFY_COUNT"
              echo ""
            else
              echo "‚ùå StructsAndEnums.cs not found"
            fi

            echo "‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê"
            echo ""
            echo "üìã ApiDefinitions.cs Preview (first 50 lines):"
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            head -50 "$OUTPUT_DIR/ApiDefinitions.cs"
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo ""

            echo "üìã StructsAndEnums.cs Preview (first 50 lines):"
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            head -50 "$OUTPUT_DIR/StructsAndEnums.cs"
            echo "‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ"
            echo ""

            echo "‚úÖ Pipeline completed successfully!"
          else
            echo "‚ùå Output directory not found!"
            exit 1
          fi

      - name: Upload ApiDefinitions.cs
        uses: actions/upload-artifact@v4
        with:
          name: ApiDefinitions
          path: src/Maui.MicrosoftClarity.iOS/ClarityBindingOutput/ApiDefinitions.cs
          retention-days: 30

      - name: Upload StructsAndEnums.cs
        uses: actions/upload-artifact@v4
        with:
          name: StructsAndEnums
          path: src/Maui.MicrosoftClarity.iOS/ClarityBindingOutput/StructsAndEnums.cs
          retention-days: 30

      - name: Prepare xcframework for upload
        run: |
          cd src/Maui.MicrosoftClarity.iOS
          # Create a temporary directory with the desired structure
          mkdir -p artifact-temp
          cp -r Clarity.xcframework artifact-temp/

      - name: Upload Clarity.xcframework (without .swiftmodule)
        uses: actions/upload-artifact@v4
        with:
          name: Clarity-xcframework-${{ env.CLARITY_VERSION }}
          path: src/Maui.MicrosoftClarity.iOS/artifact-temp/
          retention-days: 30

      - name: Create Summary
        run: |
          cd src/Maui.MicrosoftClarity.iOS
          OUTPUT_DIR="ClarityBindingOutput"

          echo "## üéâ iOS Bindings Generated Successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì¶ Clarity Version: $CLARITY_VERSION" >> $GITHUB_STEP_SUMMARY
          echo "### üîó Download URL: $FRAMEWORK_URL" >> $GITHUB_STEP_SUMMARY
          echo "### üì± iOS SDK: $IOS_SDK" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìÑ Generated Files:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ -f "$OUTPUT_DIR/ApiDefinitions.cs" ]; then
            FILE_SIZE=$(ls -lh "$OUTPUT_DIR/ApiDefinitions.cs" | awk '{print $5}')
            LINE_COUNT=$(wc -l < "$OUTPUT_DIR/ApiDefinitions.cs")
            VERIFY_COUNT=$(grep -c "\[Verify" "$OUTPUT_DIR/ApiDefinitions.cs" 2>/dev/null || echo "0")
            echo "- ‚úÖ **ApiDefinitions.cs**: $FILE_SIZE, $LINE_COUNT lines, $VERIFY_COUNT [Verify] attributes" >> $GITHUB_STEP_SUMMARY
          fi

          if [ -f "$OUTPUT_DIR/StructsAndEnums.cs" ]; then
            FILE_SIZE=$(ls -lh "$OUTPUT_DIR/StructsAndEnums.cs" | awk '{print $5}')
            LINE_COUNT=$(wc -l < "$OUTPUT_DIR/StructsAndEnums.cs")
            VERIFY_COUNT=$(grep -c "\[Verify" "$OUTPUT_DIR/StructsAndEnums.cs" 2>/dev/null || echo "0")
            echo "- ‚úÖ **StructsAndEnums.cs**: $FILE_SIZE, $LINE_COUNT lines, $VERIFY_COUNT [Verify] attributes" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üì• Artifacts" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "The generated binding files are available as workflow artifacts:" >> $GITHUB_STEP_SUMMARY
          echo "- **ApiDefinitions.cs** - C# API definitions" >> $GITHUB_STEP_SUMMARY
          echo "- **StructsAndEnums.cs** - C# structs and enums" >> $GITHUB_STEP_SUMMARY
          echo "- **Clarity-xcframework-$CLARITY_VERSION** - Complete Clarity.xcframework (without .swiftmodule and .dSYM directories)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### üìù Next Steps:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifacts from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Review the generated files" >> $GITHUB_STEP_SUMMARY
          echo "3. Remove all [Verify] attributes from both files" >> $GITHUB_STEP_SUMMARY
          echo "4. Copy files to the project directory" >> $GITHUB_STEP_SUMMARY
          echo "5. Build the project on macOS (required for .NET iOS bindings)" >> $GITHUB_STEP_SUMMARY
